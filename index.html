<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singla Electricals - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Section -->
    <div id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <div class="flex flex-col items-center mb-6">
                <svg class="w-16 h-16 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                <h1 class="text-2xl font-bold text-gray-800 mt-2">Admin Login</h1>
                <p class="text-gray-500">Singla Electricals</p>
            </div>
            
            <div id="phone-input-view">
                <div class="mb-4">
                    <label for="phone-number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">+91</span>
                        <input type="tel" id="phone-number" class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 focus:ring-teal-500 focus:border-teal-500" placeholder="7027002524">
                    </div>
                </div>
                <button id="send-otp-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Send OTP</button>
            </div>

            <div id="otp-input-view" class="hidden">
                <p class="text-center text-sm text-gray-600 mb-4">Enter the OTP sent to your number.</p>
                <div class="mb-4">
                    <label for="otp-code" class="block text-sm font-medium text-gray-700 mb-1">OTP Code</label>
                    <input type="text" id="otp-code" class="block w-full border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" placeholder="123456">
                </div>
                <button id="verify-otp-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Verify & Login</button>
            </div>
            <div id="recaptcha-container" class="mt-4"></div>
            <p id="auth-status" class="text-center text-sm text-red-500 mt-4"></p>
        </div>
    </div>

    <!-- Main Dashboard (Hidden by default) -->
    <div id="dashboard-section" class="hidden">
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-teal-600">Singla Electricals - Admin Panel</h1>
                    </div>
                    <div class="flex items-center">
                        <p id="admin-phone" class="text-sm text-gray-600 mr-4"></p>
                        <button id="logout-btn" class="text-sm text-red-500 hover:underline">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 px-4">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Service Requests</h2>
                <div id="requests-list" class="space-y-4">
                    <!-- Requests will be injected here by JavaScript -->
                    <div class="text-center text-gray-500 py-8">Loading requests...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Details Modal (Hidden by default) -->
    <div id="details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Request Details</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Modal content will be injected here by JavaScript -->
            </div>
            <div class="p-6 bg-gray-50 border-t">
                <h4 class="font-bold mb-2">Admin Response</h4>
                <textarea id="admin-response-text" class="w-full border-gray-300 rounded-md p-2" rows="3" placeholder="Type your response to the customer..."></textarea>
                <div class="mt-4 flex justify-end">
                    <button id="submit-response-btn" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700">Mark as Reviewed & Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ***************************************************************
        // ***** STEP 1: APNI FIREBASE "CHAABI" (CONFIG) YAHAN PASTE KAREIN *****
        // ***************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyAWO1g-CbTgM-euAWFxinML6naTQsrHlhI",
            authDomain: "singla-electricals.firebaseapp.com",
            databaseURL: "https://singla-electricals-default-rtdb.firebaseio.com",
            projectId: "singla-electricals",
            storageBucket: "singla-electricals.firebasestorage.app",
            messagingSenderId: "195987643244",
            appId: "1:195987643244:web:2c2833c95c5e29ebbbb149",
            measurementId: "G-MM7PE87E6B"
        };
        // ***************************************************************

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // UI Elements
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const phoneInputView = document.getElementById('phone-input-view');
        const otpInputView = document.getElementById('otp-input-view');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const phoneNumberInput = document.getElementById('phone-number');
        const otpCodeInput = document.getElementById('otp-code');
        const authStatus = document.getElementById('auth-status');
        const logoutBtn = document.getElementById('logout-btn');
        const adminPhoneEl = document.getElementById('admin-phone');
        const requestsList = document.getElementById('requests-list');
        
        // Modal Elements
        const detailsModal = document.getElementById('details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalContent = document.getElementById('modal-content');
        const adminResponseText = document.getElementById('admin-response-text');
        const submitResponseBtn = document.getElementById('submit-response-btn');

        let confirmationResult;
        let currentRequestId = null;

        // Initialize Recaptcha Verifier
        window.onload = function() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible',
                'callback': (response) => { /* reCAPTCHA solved, allow signInWithPhoneNumber. */ }
            });
        };

        sendOtpBtn.addEventListener('click', async () => {
            const phoneNumber = "+91" + phoneNumberInput.value;
            const appVerifier = window.recaptchaVerifier;
            authStatus.textContent = 'Sending OTP...';

            try {
                confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, appVerifier);
                authStatus.textContent = 'OTP Sent!';
                phoneInputView.classList.add('hidden');
                otpInputView.classList.remove('hidden');
            } catch (error) {
                console.error("Error sending OTP:", error);
                authStatus.textContent = 'Error: Could not send OTP. Check number or refresh.';
                recaptchaVerifier.render().then((widgetId) => {
                    recaptchaVerifier.reset(widgetId);
                });
            }
        });
        
        verifyOtpBtn.addEventListener('click', async () => {
            const code = otpCodeInput.value;
            authStatus.textContent = 'Verifying...';
            try {
                await confirmationResult.confirm(code);
                // User is signed in. Auth state change will handle the rest.
            } catch (error) {
                console.error("Error verifying OTP:", error);
                authStatus.textContent = 'Error: Invalid OTP.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Listen for Auth State Changes
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                authStatus.textContent = 'Checking admin status...';
                const adminDoc = await db.collection('admins').doc(user.phoneNumber).get();

                if (adminDoc.exists) {
                    // It's an admin!
                    loginSection.style.display = 'none';
                    dashboardSection.style.display = 'block';
                    adminPhoneEl.textContent = `Logged in as: ${user.phoneNumber}`;
                    listenForRequests();
                } else {
                    // Not an admin
                    authStatus.textContent = 'Access Denied: You are not an admin.';
                    await auth.signOut();
                }
            } else {
                // User is signed out
                loginSection.style.display = 'flex';
                dashboardSection.style.display = 'none';
                phoneInputView.classList.remove('hidden');
                otpInputView.classList.add('hidden');
                authStatus.textContent = '';
            }
        });
        
        function listenForRequests() {
            db.collection('service_requests').orderBy('timestamp', 'desc')
              .onSnapshot((querySnapshot) => {
                  if (querySnapshot.empty) {
                      requestsList.innerHTML = '<p class="text-center text-gray-500 py-8">No service requests yet.</p>';
                      return;
                  }
                  
                  let html = '';
                  querySnapshot.forEach((doc) => {
                      const request = doc.data();
                      const date = request.timestamp ? new Date(request.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                      const statusColor = request.status === 'Reviewed' ? 'green' : 'orange';
                      
                      html += `
                        <div class="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50 cursor-pointer" onclick="showDetails('${doc.id}')">
                            <div>
                                <p class="font-bold text-lg">${request.customerName || 'N/A'}</p>
                                <p class="text-sm text-gray-600">${request.serviceType || 'N/A'} - Booked on ${date}</p>
                            </div>
                            <span class="text-xs font-bold uppercase px-2 py-1 rounded-full text-${statusColor}-800 bg-${statusColor}-200">${request.status || 'N/A'}</span>
                        </div>
                      `;
                  });
                  requestsList.innerHTML = html;
              }, (error) => {
                  console.error("Error fetching requests:", error);
                  requestsList.innerHTML = '<p class="text-center text-red-500 py-8">Error loading requests.</p>';
              });
        }
        
        async function showDetails(docId) {
            currentRequestId = docId;
            const doc = await db.collection('service_requests').doc(docId).get();
            if (!doc.exists) {
                alert('Request not found!');
                return;
            }
            
            const data = doc.data();
            adminResponseText.value = data.adminResponse || '';

            let contentHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    ${createDetailRow('Customer Name', data.customerName)}
                    ${createDetailRow('Phone', data.customerPhone)}
                    ${createDetailRow('Service', data.serviceType)}
                    ${createDetailRow('Amount', `₹${data.bookingAmount}`)}
                    ${createDetailRow('Address', data.customerAddress, true)}
                    ${createDetailRow('Issue', data.issueDescription, true)}
                    ${createDetailRow('Status', data.status)}
                    ${createDetailRow('Payment ID', data.paymentId)}
                </div>
            `;
            modalContent.innerHTML = contentHtml;
            detailsModal.classList.add('active');
        }
        
        function createDetailRow(label, value, fullWidth = false) {
            return `
                <div class="${fullWidth ? 'md:col-span-2' : ''} border-t pt-2">
                    <p class="font-bold text-gray-600">${label}</p>
                    <p class="text-gray-800">${value || 'N/A'}</p>
                </div>
            `;
        }

        closeModalBtn.addEventListener('click', () => detailsModal.classList.remove('active'));

        submitResponseBtn.addEventListener('click', async () => {
            if (!currentRequestId) return;
            submitResponseBtn.textContent = 'Submitting...';
            submitResponseBtn.disabled = true;

            try {
                await db.collection('service_requests').doc(currentRequestId).update({
                    status: 'Reviewed',
                    adminResponse: adminResponseText.value
                });
                detailsModal.classList.remove('active');
            } catch (error) {
                console.error("Error submitting response:", error);
                alert('Failed to submit response.');
            } finally {
                submitResponseBtn.textContent = 'Mark as Reviewed & Submit';
                submitResponseBtn.disabled = false;
                currentRequestId = null;
            }
        });

    </script>
</body>
</html>

